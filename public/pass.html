<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phantom Recovery - Reset Password</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="/socket.io/socket.io.js"></script>
<style>
/* ---------------- Reset & Base ---------------- */
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color:#f8fafc; overflow-x:hidden; }
body { padding:2rem; position: relative; }

/* ---------------- Animated Background ---------------- */
.bg-animation{position:fixed;inset:0;z-index:0;}
.floating-shape{position:absolute;border-radius:50%;filter:blur(80px);opacity:0.3;animation:float 20s infinite ease-in-out;}
.shape1{width:400px;height:400px;background:radial-gradient(circle, rgba(124,58,237,0.4), transparent);top:-200px;left:-200px;}
.shape2{width:350px;height:350px;background:radial-gradient(circle, rgba(236,72,153,0.4), transparent);bottom:-150px;right:-150px;}
@keyframes float{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(30px,-30px) scale(1.1);}66%{transform:translate(-20px,20px) scale(0.9);}}

/* ---------------- Reset Container ---------------- */
.reset-container{
  position:relative; z-index:2; max-width:500px; width:100%; margin:2rem auto;
  background: rgba(255,255,255,0.15); backdrop-filter: blur(20px);
  border:1px solid rgba(124,58,237,0.3); border-radius:1.5rem; padding:2.5rem 2rem;
  box-shadow:0 20px 60px rgba(0,0,0,0.4); animation:slideIn 0.8s ease;
}
@keyframes slideIn{from{opacity:0; transform:translateY(30px);}to{opacity:1; transform:translateY(0);}}

/* ---------------- Headers ---------------- */
.reset-header{text-align:center;margin-bottom:2rem;}
.reset-title{
  font-size:2rem;font-weight:700;margin-bottom:0.5rem;
  background: linear-gradient(135deg,#7c3aed,#a855f7,#ec4899);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text; animation: gradientFlow 3s infinite; background-size:200% 200%;
}
@keyframes gradientFlow{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
.reset-subtitle{color:#94a3b8;font-size:1rem;}

/* ---------------- Form Styles ---------------- */
.form-group{margin-bottom:1.5rem;}
.form-label{display:block;margin-bottom:0.5rem;color:#cbd5e1;font-weight:500;font-size:0.9rem;}
.form-label span{color:#ef4444;}
.input-wrapper{position:relative;}
.input-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:#94a3b8;font-size:1.1rem;}
.form-input{
  width:100%;padding:1rem 1rem 1rem 3rem;
  background: rgba(255,255,255,0.2); border:1px solid rgba(124,58,237,0.3);
  border-radius:0.5rem;color:#f8fafc;font-size:1rem; transition: all 0.3s ease;
}
.form-input:focus{outline:none;border-color:#a855f7;box-shadow:0 0 20px rgba(168,85,247,0.3);background: rgba(255,255,255,0.25);}
.form-input.error{border-color:#ef4444;}
.form-input.success{border-color:#10b981;}
.submit-btn{width:100%; padding:1rem; border:none; border-radius:0.5rem; background:#7c3aed; color:#fff; font-size:1rem; cursor:pointer; transition: all 0.3s ease;}
.submit-btn:hover{background:#a855f7;}
.success-message{background: rgba(16,185,129,0.2); border-left: 4px solid #10b981; color:#f8fafc; padding:0.8rem 1rem; margin-bottom:1rem; border-radius:0.5rem; display:none;}
.success-message.show{display:block;}
.error-message{background: rgba(239,68,68,0.2); border-left: 4px solid #ef4444; color:#f8fafc; padding:0.8rem 1rem; margin-bottom:1rem; border-radius:0.5rem; display:none;}

/* ---------------- OTP Inputs ---------------- */
.otp-container{display:flex;justify-content:space-between;margin:1.5rem 0;}
.otp-input{
  width:3rem;height:3rem;text-align:center;font-size:1.5rem;
  border-radius:0.5rem;border:1px solid rgba(124,58,237,0.3);
  background: rgba(255,255,255,0.2);color:#f8fafc; transition: all 0.3s;
}
.otp-input:focus{outline:none;border-color:#a855f7;box-shadow:0 0 15px rgba(168,85,247,0.3);}
.timer-resend{display:flex;justify-content:space-between;align-items:center;margin-top:1rem;font-size:0.9rem;color:#94a3b8;}
.timer-resend button{background:none;border:none;color:#7c3aed;cursor:pointer;}
.timer-resend button:disabled{color:gray;cursor:not-allowed;}

/* ---------------- Mobile ---------------- */
@media (max-width:480px){
  body{padding:1rem;}
  .reset-container{padding:1.5rem 1rem; margin:1rem auto;}
  .reset-title{font-size:1.7rem;}
  .reset-subtitle{font-size:0.9rem;}
  .form-label{font-size:0.85rem;}
  .form-input{font-size:0.95rem; padding:0.8rem 0.8rem 0.8rem 2.5rem;}
  .input-icon{font-size:1rem; left:0.8rem;}
  .submit-btn{font-size:0.95rem; padding:0.85rem;}
  .otp-input{width:2.5rem;height:2.5rem;font-size:1.2rem;}
}
</style>
</head>
<body>
<div class="bg-animation">
  <div class="floating-shape shape1"></div>
  <div class="floating-shape shape2"></div>
</div>

<!-- ---------------- Tabs ---------------- -->
<div class="tabs">
  <button class="tab active" data-tab="profileTab">Profile</button>
  <button class="tab" data-tab="preferencesTab">Preferences</button>
  <button class="tab" data-tab="securityTab">Security</button>
  <button class="tab" data-tab="sessionsTab">Sessions</button>
  <button class="tab" data-tab="notificationsTab">Notifications</button>
  <button class="tab" data-tab="walletsTab">Wallets</button>
  <button class="tab" data-tab="activityTab">Activity</button>
  <button class="tab" data-tab="actionsTab">Actions</button>
</div>

<!-- ---------------- Password Reset Flow (Independent) ---------------- -->
<div id="resetEmailStep" class="reset-container">
  <div class="reset-header">
    <h1 class="reset-title">Forgot Password</h1>
    <p class="reset-subtitle">Enter your email to receive a verification code</p>
  </div>
  <form id="emailForm">
    <div class="form-group">
      <label class="form-label">Email Address <span>*</span></label>
      <div class="input-wrapper">
        <i class="fas fa-envelope input-icon"></i>
        <input type="email" class="form-input" id="email" placeholder="john.doe@example.com" required>
      </div>
      <div class="error-message" id="emailError">Please enter a valid email address</div>
    </div>
    <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Send Code</button>
    <div class="success-message" id="emailSuccess">Code sent! Check your email.</div>
  </form>
</div>

<div id="resetOtpStep" class="reset-container" style="display:none;">
  <div class="reset-header">
    <h1 class="reset-title">Enter Verification Code</h1>
    <p class="reset-subtitle">We sent a 6-digit code to <span id="maskedEmail"></span></p>
  </div>
  <div class="otp-container">
    <input type="text" maxlength="1" class="otp-input" />
    <input type="text" maxlength="1" class="otp-input" />
    <input type="text" maxlength="1" class="otp-input" />
    <input type="text" maxlength="1" class="otp-input" />
    <input type="text" maxlength="1" class="otp-input" />
    <input type="text" maxlength="1" class="otp-input" />
  </div>
  <div class="timer-resend">
    <span id="timer">01:30</span>
    <button id="resendBtn" disabled>Resend Code</button>
  </div>
  <button class="submit-btn" id="verifyBtn">Verify Code</button>
  <div class="success-message" id="otpSuccess">Code verified â€” set your new password.</div>
  <div class="error-message" id="otpError">Incorrect code. Try again.</div>
</div>

<div id="resetPasswordStep" class="reset-container" style="display:none;">
  <div class="reset-header">
    <h1 class="reset-title">Set New Password</h1>
    <p class="reset-subtitle">Enter a secure password to complete your reset</p>
  </div>
  <form id="passwordForm">
    <div class="form-group">
      <label class="form-label">New Password <span>*</span></label>
      <div class="input-wrapper">
        <i class="fas fa-lock input-icon"></i>
        <input type="password" class="form-input" id="newPassword" placeholder="New Password" required>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Confirm Password <span>*</span></label>
      <div class="input-wrapper">
        <i class="fas fa-lock input-icon"></i>
        <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm Password" required>
      </div>
    </div>
    <button type="submit" class="submit-btn">Set Password</button>
    <div class="success-message" id="passwordSuccess">Password updated successfully!</div>
    <div class="error-message" id="passwordError">Passwords do not match or too weak.</div>
  </form>
</div>

<!-- ---------------- Tabs Content ---------------- -->
<div id="profileTab" class="tab-content">
  <div id="profileContainer"></div>
</div>

<div id="preferencesTab" class="tab-content" style="display:none;">
  <h2>Preferences</h2>
</div>

<div id="securityTab" class="tab-content" style="display:none;">
  <h2>Security</h2>
</div>

<div id="sessionsTab" class="tab-content" style="display:none;">
  <h2>Sessions</h2>
  <ul id="activeSessions"></ul>
</div>

<div id="notificationsTab" class="tab-content" style="display:none;">
  <h2>Notifications</h2>
  <ul id="notificationList"></ul>
</div>

<div id="walletsTab" class="tab-content" style="display:none;">
  <h2>Wallets</h2>
  <div id="walletContent"></div>
</div>

<div id="activityTab" class="tab-content" style="display:none;">
  <h2>Activity</h2>
  <ul id="activityList"></ul>
</div>

<div id="actionsTab" class="tab-content" style="display:none;">
  <h2>Actions</h2>
</div>

<script>
const socket = io("http://localhost:3000"); // connect to Socket.IO server

// ---------------- DOM Elements ----------------
const emailForm = document.getElementById('emailForm');
const emailInput = document.getElementById('email');
const emailError = document.getElementById('emailError');
const emailSuccess = document.getElementById('emailSuccess');
const emailStep = document.getElementById('emailStep');

const otpStep = document.getElementById('otpStep');
const otpInputs = document.querySelectorAll('.otp-input');
const verifyBtn = document.getElementById('verifyBtn');
const otpError = document.getElementById('otpError');
const otpSuccess = document.getElementById('otpSuccess');
const maskedEmail = document.getElementById('maskedEmail');
const timerDisplay = document.getElementById('timer');
const resendBtn = document.getElementById('resendBtn');

const passwordStep = document.getElementById('passwordStep');
const passwordForm = document.getElementById('passwordForm');
const newPassword = document.getElementById('newPassword');
const confirmPassword = document.getElementById('confirmPassword');
const passwordSuccess = document.getElementById('passwordSuccess');
const passwordError = document.getElementById('passwordError');

const profileContainer = document.getElementById('profile'); // optional container for user info

const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');

let timerInterval;

// ---------------- Helper Functions ----------------
function startTimer(seconds) {
  if (!resendBtn) return;
  resendBtn.disabled = true;
  let time = seconds;
  updateTimerDisplay(time);
  timerInterval = setInterval(() => {
    time--;
    updateTimerDisplay(time);
    if (time <= 0) {
      clearInterval(timerInterval);
      resendBtn.disabled = false;
    }
  }, 1000);
}

function updateTimerDisplay(seconds) {
  if (!timerDisplay) return;
  const m = Math.floor(seconds / 60).toString().padStart(2, '0');
  const s = (seconds % 60).toString().padStart(2, '0');
  timerDisplay.textContent = `${m}:${s}`;
}

// ---------------- Tab Switching ----------------
if (tabs && contents) {
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      contents.forEach(c => c.style.display = 'none');

      const id = tab.getAttribute('data-tab');
      const content = document.getElementById(id);
      if (content) content.style.display = 'block';
    });
  });
}

// ---------------- Email Step ----------------
if (emailForm) {
  emailForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const emailVal = emailInput.value.trim();
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!re.test(emailVal)) {
      emailInput.classList.add('error');
      emailError.style.display = 'block';
      emailSuccess.style.display = 'none';
      return;
    }

    try {
      const res = await fetch('/api/auth/request-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailVal })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      emailInput.classList.remove('error');
      emailInput.classList.add('success');
      emailError.style.display = 'none';
      emailSuccess.style.display = 'block';

      socket.emit('otpRequested', { email: emailVal });

      setTimeout(() => {
        if (emailStep && otpStep) {
          emailStep.style.display = 'none';
          otpStep.style.display = 'block';
        }
        if (maskedEmail) maskedEmail.textContent = emailVal.replace(/(.{1}).+(@.+)/, "$1***$2");
        startTimer(90);
      }, 1000);
    } catch (err) {
      emailError.textContent = err.message;
      emailError.style.display = 'block';
      emailSuccess.style.display = 'none';
    }
  });
}

// ---------------- OTP Step ----------------
if (otpInputs && verifyBtn) {
  otpInputs.forEach((input, i) => {
    input.addEventListener('input', () => {
      if (input.value.length === 1 && i < otpInputs.length - 1) otpInputs[i + 1].focus();
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && input.value === '' && i > 0) otpInputs[i - 1].focus();
    });
  });

  verifyBtn.addEventListener('click', async () => {
    const code = Array.from(otpInputs).map(i => i.value).join('');
    const emailVal = emailInput.value.trim();

    try {
      const res = await fetch('/api/auth/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailVal, otp: code })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      otpError.style.display = 'none';
      otpSuccess.style.display = 'block';
      socket.emit('otpVerified', { email: emailVal });

      setTimeout(() => {
        if (otpStep && passwordStep) {
          otpStep.style.display = 'none';
          passwordStep.style.display = 'block';
        }
      }, 500);
    } catch (err) {
      otpError.textContent = err.message;
      otpError.style.display = 'block';
      otpSuccess.style.display = 'none';
    }
  });
}

// ---------------- Resend OTP ----------------
if (resendBtn) {
  resendBtn.addEventListener('click', async () => {
    otpInputs.forEach(input => input.value = '');
    startTimer(90);
    try {
      const res = await fetch('/api/auth/request-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailInput.value.trim() })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      alert('A new code has been sent to your email.');
      socket.emit('otpResent', { email: emailInput.value.trim() });
    } catch (err) {
      alert('Failed to resend OTP: ' + err.message);
    }
  });
}

// ---------------- Password Step ----------------
if (passwordForm) {
  passwordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const emailVal = emailInput.value.trim();

    if (newPassword.value.length < 6) {
      passwordError.textContent = 'Password too short, min 6 chars';
      passwordError.style.display = 'block';
      passwordSuccess.style.display = 'none';
      return;
    }
    if (newPassword.value !== confirmPassword.value) {
      passwordError.textContent = 'Passwords do not match';
      passwordError.style.display = 'block';
      passwordSuccess.style.display = 'none';
      return;
    }

    try {
      const res = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailVal, password: newPassword.value })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      passwordError.style.display = 'none';
      passwordSuccess.style.display = 'block';
      socket.emit('passwordReset', { email: emailVal });

      const profileRes = await fetch(`/api/auth/profile?email=${encodeURIComponent(emailVal)}`);
      const profileData = await profileRes.json();
      if (profileRes.ok && profileContainer) {
        profileContainer.innerHTML = `
          <h2>Welcome, ${profileData.name}</h2>
          <p>Email: ${profileData.email}</p>
        `;
      }

    } catch (err) {
      passwordError.textContent = err.message;
      passwordError.style.display = 'block';
      passwordSuccess.style.display = 'none';
    }
  });
}
// ---------------- Tabs ----------------
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    // Highlight active tab
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    // Show corresponding tab content
    const target = tab.getAttribute('data-tab');
    tabContents.forEach(c => {
      c.style.display = c.id === target ? 'block' : 'none';
    });
  });
});


// ---------------- Live Socket Updates ----------------

// Notifications
socket.on('notification', data => {
  const notifList = document.getElementById('notificationList');
  if (notifList) {
    const li = document.createElement('li');
    li.textContent = data.message;
    notifList.prepend(li);
  }
});

// Wallet updates
socket.on('walletUpdate', data => {
  const walletContent = document.getElementById('walletContent');
  if (walletContent) {
    walletContent.innerHTML = `<p>Balance: ${data.balance} ${data.currency}</p>`;
  }
});

// Active sessions
socket.on('sessionUpdate', data => {
  const sessionList = document.getElementById('activeSessions');
  if (sessionList) {
    sessionList.innerHTML = '';
    data.sessions.forEach(s => {
      const li = document.createElement('li');
      li.textContent = `${s.device} - ${s.ip} - ${s.lastActive}`;
      sessionList.appendChild(li);
    });
  }
});

// Activity log
socket.on('activityUpdate', data => {
  const activityList = document.getElementById('activityList');
  if (activityList) {
    const li = document.createElement('li');
    li.textContent = `${data.time}: ${data.action}`;
    activityList.prepend(li);
  }
});

// OTP & Password Reset Updates
socket.on('otpSent', ({ email }) => {
  if (email === emailInput.value.trim()) {
    emailSuccess.style.display = 'block';
    emailError.style.display = 'none';
  }
});

socket.on('otpVerified', ({ email }) => {
  if (email === emailInput.value.trim()) {
    otpSuccess.style.display = 'block';
    otpError.style.display = 'none';
  }
});

socket.on('passwordReset', ({ email }) => {
  if (email === emailInput.value.trim()) {
    passwordSuccess.style.display = 'block';
    passwordError.style.display = 'none';
  }
});

</script>
</body>
</html>
